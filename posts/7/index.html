
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Matt Ward</title>
  <meta name="author" content="Matt Ward">

  
  <meta name="description" content="How do you clone a CodePlex Git repository over to GitHub? Here we take a look at how to clone the Entity Framework Git repository, which is &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://lastexitcode.com/posts/7">
  <link href="/favicon.ico" rel="icon" type="image/x-icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Matt Ward" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='//fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='//fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-34592677-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Matt Ward</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
  
  
  
  
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="lastexitcode.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/projects/">Projects</a></li>
  <li><a href="/blog/archives/">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/09/26/CloneCodePlexRepositoryToGitHub/">Cloning a CodePlex Repository over to GitHub</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-09-26T16:36:00+01:00" pubdate data-updated="true">Sep 26<sup>th</sup>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>How do you clone a CodePlex Git repository over to GitHub?</p>

<p>Here we take a look at how to clone the<a href="http://entityframework.codeplex.com/"> Entity Framework Git repository</a>, which is available on CodePlex, over to GitHub. The goal is to be able to take new commits from the original CodePlex Git repository and update the repository being hosted on GitHub.</p>

<ol>
<li><p>Create a repository on GitHub.</p>

<p> Do not initialise the repository with a readme file just create the repository. We are going to call this repository entityframework-sharpdevelop since this will be a port of the Entity Framework which will work with SharpDevelop.</p></li>
<li><p>Clone the CodePlex repository to your local machine.</p>

<p> Using your favourite Git client clone the Entity Framework repository at CodePlex to your local machine.</p>

<pre><code> git clone https://git01.codeplex.com/entityframework entityframework
</code></pre></li>
<li><p>Configure Git Remotes</p>

<p> Our goal is to have a setup similar to the following.</p>

<pre><code> git remote -v

 origin  git@github.com:mrward/entityframework-sharpdevelop.git (fetch)
 origin  git@github.com:mrward/entityframework-sharpdevelop.git (push)
 upstream        https://git01.codeplex.com/entityframework (fetch)
 upstream        https://git01.codeplex.com/entityframework (push)
</code></pre>

<p> We want an upstream remote that points to the original Entity Framework repository on CodePlex. We also want an origin remote that points our GitHub repository</p>

<p> First we create the upstream remote by renaming the origin remote. From inside the entityframework folder we run the following command.</p>

<pre><code> git remote rename origin upstream
</code></pre>

<p> Now we add the new origin remote.</p>

<pre><code> git remote add origin git@github.com:mrward/entityframework-sharpdevelop.git
</code></pre>

<p> Run <strong>git remote -v</strong> to check that the configuration is correct.</p></li>
<li><p>Push the code to GitHub</p>

<pre><code> git push -u origin master
</code></pre></li>
<li><p>Get the latest Entity Framework Commits into GitHub</p>

<p> Now when you want to get the latest Entity Framework commits from CodePlex you can run the following commands to merge these commits into your local master branch.</p>

<pre><code> git fetch upstream
 git merge upstream/master
</code></pre>

<p> Then you can push the changes up to GitHub.</p></li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/09/26/CreatingAGitHubHostedBlogWithOctopress/">Creating a GitHub hosted blog with Octopress</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-09-26T13:55:00+01:00" pubdate data-updated="true">Sep 26<sup>th</sup>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://octopress.org/">Octopress</a> is a blogging framework created by Brandon Mathis. Octopress has great documentation on how to setup Octopress on a <a href="http://pages.github.com/">GitHub hosted blog</a> which this guide is not trying to replace. The following guide is a simple overview of how to setup Octopress with Windows being used to create the blog posts and push them to GitHub.</p>

<h2>Prerequisites</h2>

<ol>
<li>You have GitHub account.</li>
<li>You have a Git client, such as Tortoise Git, installed.</li>
</ol>


<h2>Software Versions</h2>

<p>This guide is based on the using the following software:</p>

<ul>
<li>Octopress 2.0</li>
<li>Windows 7 (client machine)</li>
<li>Ruby 1.9.3</li>
</ul>


<h2>How to setup a GitHub based blog with Octopress</h2>

<ol>
<li>Download and install Ruby 1.9.3 from <a href="http://rubyinstaller.org/downloads/">http://rubyinstaller.org/downloads/</a></li>
<li><p>Add ruby to your path</p>

<pre><code> PATH=c:\ruby193\bin
</code></pre></li>
<li><p>Download the <a href="https://GitHub.com/oneclick/rubyinstaller/wiki/Development-Kit">Ruby devkit</a> from <a href="http://rubyinstaller.org/downloads/">http://rubyinstaller.org/downloads/</a></p>

<p> Extract to c:\RubyDevKit</p>

<p> Change into this folder and run</p>

<pre><code> ruby dk.rb init
 ruby dk.rb install
</code></pre>

<p> If you do not install the Ruby devkit then you will get an error when running setting up Octopress and running gem in step 5):</p>

<pre><code> Gem::InstallError: The 'posix-spawn' native gem requires installed build tools.
</code></pre></li>
<li><p>Clone octopress</p>

<pre><code> git://GitHub.com/imathis/octopress.git octopress
</code></pre></li>
<li><p>Setup Octopress</p>

<p> Open a command prompt in the octopress folder. Run the following commands</p>

<pre><code> gem install bundler
 bundle install
 rake install
 rake generate
 rake preview
</code></pre>

<p> Then open a browser and go to <a href="http://localhost:4000">http://localhost:4000</a> to view your blog.</p></li>
<li><p>Create a GitHub repository for your blog</p>

<p> See the <a href="http://octopress.org/docs/deploying/github/">Octopress guide</a>.</p>

<p> Create a new repository in GitHub that has your GitHub username followed by .github.com (e.g. mrward.github.com).</p></li>
<li><p>Deploy your blog to GitHub</p>

<p> From the octopress folder run</p>

<pre><code> rake setup_GitHub_pages
 rake generate
 rake deploy
</code></pre>

<p> The deploy command will cause your blog to be pushed to the master branch of your GitHub repository. Your blog will then be published and accessible via <a href="http://username.github.com">http://username.github.com</a> (where username is replaced with your GitHub username).</p>

<p> Then you will need to commit your changes made in the source branch and push them to GitHub.</p>

<p> You now have a repository on GitHub containing your blog. It will have two branches master and source. The master branch contains your blog web pages. The source branch contains the octopress files and your original blog posts. On your local machine the master branch will exist in the _deploy folder. The octopress folder will be tracking the source branch.</p></li>
<li><p>Configure your blog</p>

<p> You will want to configure various settings, such as google analytics, for your blog. The <a href="http://octopress.org/docs/configuring/">documentation on the Octopress site</a> has the full details on how to configure everything.</p></li>
<li><p>Creating blog posts</p>

<p> From the Octopress folder run:</p>

<pre><code> rake new_post["Name of your post"]
</code></pre>

<p> This will generate a file in the source\_posts folder which you can edit.</p>

<p> To generate your blog and preview it in the browser run</p>

<pre><code> rake generate
 rake preview
</code></pre>

<p> The generate command will regenerate your blog web pages in the public folder. You will need to copy these files to the _deploy folder. The final step is then to commit and push your changes to GitHub. You will want to commit the changes made in the Octopress folder (i.e. the source branch) and also your blog pages in the _deploy folder (i.e. the master branch). You can use the rake deploy command to automate this copying of pages, committing and pushing your blog web pages to GitHub but if you want more control over the commit message then you can do this final set of steps yourself and commit the pages using your favourite Git client.</p></li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/09/25/ExecutionEngineExceptionThrownWhenUsingCodeContracts/">ExecutionEngineException thrown when using Code Contracts</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-09-25T17:35:00+01:00" pubdate data-updated="true">Sep 25<sup>th</sup>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Whilst changing the Entity Framework 5.0 NuGet package to work with <a href="http://www.icsharpcode.net/OpenSource/SD/">SharpDevelop</a> a custom build of the NuGet package was causing Visual Studio 2010 to crash when the package was being installed. Debugging the crash by attaching another instance of Visual Studio revealed that an <a href="http://msdn.microsoft.com/en-us/library/system.executionengineexception.aspx">ExecutionEngineException</a> was being thrown when the following line of code was being executed.</p>

<pre><code>Contract.Requires(project != null);
</code></pre>

<p>The exception itself had no other information. The exception&rsquo;s message just repeated the exception that was being thrown: &ldquo;Exception of type &lsquo;System.ExecutionEngineException&rsquo; was thrown.&rdquo;. This exception indicates an internal error occurred in the CLR execution engine.</p>

<p>The real problem is the use of <a href="http://research.microsoft.com/en-us/projects/contracts/">Code Contracts</a> and not following the <a href="http://entityframework.codeplex.com/documentation">Entity Framework documentation on how to build it from source code</a>.</p>

<p>The <a href="http://msdn.microsoft.com/en-us/library/system.diagnostics.contracts.contract.aspx">Contract</a> class is used to define required preconditions and postconditions for a method and is used when defining Code Contracts. It is part of the .NET Framework 4.0 and can be found in mscorlib.dll in the System.Diagnostics.Contracts namespace.</p>

<p>The problem with the custom build of Entity Framework is that there are parts of Code Contracts included with .NET Framework 4.0 so you can compile a project that uses Code Contracts without any errors but on running the application you can have an ExecutionEngineException thrown. This can occur if you do not have the <a href="http://msdn.microsoft.com/en-us/devlabs/dd491992.aspx">Code Contracts Visual Studio extension</a> installed when the project is built. With this extension installed your assembly will be modified when it is compiled by the code contracts binary rewriter.  The rewriter will inject the contracts into your assembly so the checks will be run when the code is executed.</p>

<h2>Solution</h2>

<p>To get around this problem you have two options.</p>

<ol>
<li><p>Install the <a href="http://msdn.microsoft.com/en-us/devlabs/dd491992.aspx">Code Contracts</a> Visual Studio extension and then rebuild your project. After installing you should have a Code Contracts page in your project options.</p></li>
<li><p>Remove <a href="http://msmvps.com/blogs/luisabreu/archive/2008/11/12/code-contracts-and-runtime-rewriting.aspx">CONTRACTS_FULL</a> from the conditional compilation symbols in the project&rsquo;s options.</p></li>
</ol>


<p>CONTRACTS_FULL is used to enable runtime checking of the code contracts. If this is not defined then the calls made to the any of Contract methods are ignored by the compiler when building your project.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/10/13/T4TemplatePropertiesAspNetMvc3/">ASP.NET MVC 3 T4 Template Properties</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-10-13T21:30:00+01:00" pubdate data-updated="true">Oct 13<sup>th</sup>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Here are the properties that ASP.NET MVC 3.0 provides to T4 templates when you use the Add View and Add Controller dialogs inside Visual Studio 2010.</p>

<h2>Add Controller</h2>

<table class="article" title="T4 template controller properties for ASP.NET MVC 3.0">
  <thead>
    <tr>
      <th>Property Name</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>AddActionMethods</td>
      <td>Boolean</td>
      <td>Adds action methods to the generated controller 
      class.</td>
    </tr>
    <tr>
      <td>AreaName</td>
      <td>System.String</td>
      <td>The name of the Area that the controller is created 
      for.</td>
    </tr>
    <tr>
      <td>ContextType</td>
      <td>System.Type</td>
      <td>The type of the data context.</td>
    </tr>
    <tr>
      <td>ControllerName</td>
      <td>String</td>
      <td>The name of the controller class that will be 
      generated.</td>
    </tr>
    <tr>
      <td>ControllerRootName</td>
      <td>String</td>
      <td>The name of the controller class excluding the Controller 
      part at the end of the name.</td>
    </tr>
    <tr>
      <td>EntitySetName</td>
      <td>String</td>
      <td>Name of the property on the data context class containing 
      the set of entities.</td>
    </tr>
    <tr>
      <td>ModelType</td>
      <td>System.Type</td>
      <td>The type of the model class specified in the Add 
      Controller dialog.</td>
    </tr>
    <tr>
      <td>Namespace</td>
      <td>String</td>
      <td>Namespace that will be used for the generated controller 
      class.</td>
    </tr>
    <tr>
      <td>PrimaryKeys</td>
      <td>
        PrimaryKey[]
        <br />
        (Microsoft.
        <br />
        VisualStudio.
        <br />
        Web.Mvc.
        <br />
        Scaffolding.
        <br />
        BuiltIn)
      </td>
      <td>Primary keys for the model. See table at end for 
      PrimaryKey properties.</td>
    </tr>
    <tr>
      <td>RelatedProperties</td>
      <td>
        Dictionary&lt;String,
        <br />
        RelatedModel
        <br />
        (Microsoft.
        <br />
        VisualStudio.
        <br />
        Web.
        <br />
        Mvc.
        <br />
        Scaffolding.
        <br />
        BuiltIn)&gt;
      </td>
      <td>Related properties on the model. See table at end for 
      RelatedModel properties.</td>
    </tr>
  </tbody>
</table>


<h2>Add View</h2>

<table class="article" title="T4 template view properties for ASP.NET MVC 3.0">
  <thead>
    <tr>
      <th>Property Name</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>AreaName</td>
      <td>System.String</td>
      <td>The name of the Area that the view is being created 
      for.</td>
    </tr>
    <tr>
      <td>ContentPlaceHolderIDs</td>
      <td>List&lt;string&gt;</td>
      <td>List of content place holder IDs in the master page.</td>
    </tr>
    <tr>
      <td>IsContentPage</td>
      <td>Boolean</td>
      <td>True if the generated view will be created with a master 
      page or a Razor layout page.</td>
    </tr>
    <tr>
      <td>IsPartialView</td>
      <td>Boolean</td>
      <td>True if the generated view is a partial view (e.g. an 
      ASP.NET user control).</td>
    </tr>
    <tr>
      <td>MasterPageFile</td>
      <td>String</td>
      <td>Master page file or Razor layout to be used with view 
      (e.g. ~/Views/Shared/Site.Master).</td>
    </tr>
    <tr>
      <td>Namespace</td>
      <td>String</td>
      <td>Namespace that will be used for the generated view.</td>
    </tr>
    <tr>
      <td>PrimaryContentPlaceHolderID</td>
      <td>String</td>
      <td>Primary content place holder ID to be used when creating 
      a view using a master page.</td>
    </tr>
    <tr>
      <td>ReferenceScriptLibraries</td>
      <td>Boolean</td>
      <td>True if checked in the Add View dialog.</td>
    </tr>
    <tr>
      <td>ViewDataType</td>
      <td>System.Type</td>
      <td>The view model&apos;s type.</td>
    </tr>
    <tr>
      <td>ViewDataTypeName</td>
      <td>String</td>
      <td>Fully qualified name for the view model&apos;s type.</td>
    </tr>
    <tr>
      <td>ViewName</td>
      <td>String</td>
      <td>Name of the view.</td>
    </tr>
  </tbody>
</table>


<h2>Common Properties</h2>

<table class="article" title="T4 template common properties for ASP.NET MVC 3.0">
  <thead>
    <tr>
      <th>Property Name</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>AssemblyPath</td>
      <td>List&lt;string&gt;</td>
      <td>List of assemblies referenced by the project and the 
      project&apos;s output assembly. Internal use.</td>
    </tr>
    <tr>
      <td>Errors</td>
      <td>
        CompilerErrorCollection
        <br />
        (System.CodeDom.Compiler)
      </td>
      <td>Used to stored errors that occur whilst processing the T4 
      template. Internal use.</td>
    </tr>
    <tr>
      <td>FileEncoding</td>
      <td>System.Text.Encoding</td>
      <td>The encoding of the file that will be generated.</td>
    </tr>
    <tr>
      <td>FileExtension</td>
      <td>String</td>
      <td>Not set.</td>
    </tr>
    <tr>
      <td>FrameworkVersion</td>
      <td>System.Version</td>
      <td>The .NET framework version.</td>
    </tr>
    <tr>
      <td>OutputFileExtension</td>
      <td>System.String</td>
      <td>The extension of the file that will be generated.</td>
    </tr>
    <tr>
      <td>TemplateFile</td>
      <td>System.String</td>
      <td>The full path to the T4 template file being used.</td>
    </tr>
  </tbody>
</table>


<h2>Primary Key Properties</h2>

<table class="article" title="T4 template common properties for ASP.NET MVC 3.0">
  <thead>
    <tr>
      <th>Property Name</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Name</td>
      <td>String</td>
      <td/>
    </tr>
    <tr>
      <td>ShortTypeName</td>
      <td>String</td>
      <td/>
    </tr>
    <tr>
      <td>Type</td>
      <td>System.Type</td>
      <td/>
    </tr>
  </tbody>
</table>


<h2>Related Model Properties</h2>

<table class="article" title="T4 template common properties for ASP.NET MVC 3.0">
  <thead>
    <tr>
      <th>Property Name</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>DisplayPropertyName</td>
      <td>String</td>
      <td/>
    </tr>
    <tr>
      <td>EntitySetName</td>
      <td>String</td>
      <td/>
    </tr>
    <tr>
      <td>ForeignKeyPropertyName</td>
      <td>String</td>
      <td/>
    </tr>
    <tr>
      <td>PrimaryKey</td>
      <td>String</td>
      <td/>
    </tr>
    <tr>
      <td>PropertyName</td>
      <td>String</td>
      <td/>
    </tr>
    <tr>
      <td>TypeName</td>
      <td>String</td>
      <td/>
    </tr>
  </tbody>
</table>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/10/04/T4ImportNamespaceAlias/">T4 Import Directive - Namespace Alias</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-10-04T19:54:00+01:00" pubdate data-updated="true">Oct 4<sup>th</sup>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>How do you specify a namespace alias when using the <a href="http://msdn.microsoft.com/en-us/library/gg586948.aspx">Import directive</a> in a T4 template?</p>

<p>The <a href="http://msdn.microsoft.com/en-us/library/gg586948.aspx">Import directive</a> in a T4 template is used to bring a namespace  into scope for any code that will be run when the T4 template is processed. Here is an example template that imports the System.IO namespace without using a namespace alias.</p>

<pre><code>&lt;#@ template language="C#" #&gt; 
&lt;#@ output extension=".txt" #&gt; 
&lt;#@ import namespace="System.IO" #&gt; 
&lt;# 
 string text = File.ReadAllText(@"d:\MyFile.txt"); 
#&gt; 
File content: &lt;#= text #&gt;
</code></pre>

<p>The T4 template reads all the text in the d:\MyFile.txt which is then saved in the file generated by the template.</p>

<p>If you want to use a namespace alias you can specify it in the import directive in a similar way to how it is done with C# or VB.NET. Here is the example template modified so that an alias of IO is used for the System.IO namespace.</p>

<pre><code>&lt;#@ template language="C#" #&gt; 
&lt;#@ output extension=".txt" #&gt; 
&lt;#@ import namespace="IO = System.IO" #&gt; 
&lt;# 
 string text = IO.File.ReadAllText(@"d:\temp\test.xsd"); 
#&gt; 
File content: &lt;#= text #&gt;
</code></pre>

<h2>Why does this Work?</h2>

<p>T4 templates use the  <a href="http://msdn.microsoft.com/en-us/library/y2k85ax6.aspx">CodeDom</a> to generate C# or VB.NET code which is then executed as the template is processed. When the T4 templating engine processes the Import directive it creates a    <a href="http://msdn.microsoft.com/en-us/library/system.codedom.codenamespaceimport.aspx">CodeNamespaceImport</a> Object and passes it the Namespace attribute&apos;s value. The CodeNamespaceImport object supports generating a namespace alias when you specify a string of the form &quot;Alias = Namespace&quot; and pass this to its constructor.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/08/21/UsingAntlrJavascriptParserInCSharp/">Creating a JavaScript Parser with ANTLR that can be used from CSharp</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-08-21T19:30:00+01:00" pubdate data-updated="true">Aug 21<sup>st</sup>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>How do you create a JavaScript parser that you can use from C#? One way is to use <a href="http://www.antlr.org/about.html">ANTLR</a>. ANother Tool for Language Recognition (ANTLR) is a parser generated created and maintained by Terence Parr.</p>

<p>The ANTLR website has a JavaScript grammar already defined so we will take that grammar, get ANTLR to create a parser, and then use that parser to parse some JavaScript code. The following guide is based on using <a href="http://www.antlr.org/works/index.html">ANTLRWorks 1.4.2</a>, which includes ANTLR 3.3, and the CSharp3 code generator version 3.3.1.</p>

<h2>Installing ANTLR</h2>

<ol>
<li>Install the <a href="http://www.oracle.com/technetwork/java/javase/downloads/index-jdk5-jsp-142662.html">Java JDK 1.5</a>. Newer versions than 1.5 may work with ANTLR.</li>
<li>Download <a href="http://www.antlr.org/download/antlrworks-1.4.2.jar">ANTLRWorks 1.4.2</a> (which includes Antlr 3.3).</li>
</ol>


<p>Check ANTLRWorks can be started by either double clicking the antlrworks-1.4.2.jar file or opening a command prompt and running the following command.</p>

<pre><code>java -jar antlrworks-1.4.2.jar
</code></pre>

<h2>Generating a JavaScript Parser</h2>

<p>Download a JavaScript grammar from <a href="http://www.antlr.org/grammar/list">http://www.antlr.org/grammar/list</a>](<a href="http://www.antlr.org/grammar/list">http://www.antlr.org/grammar/list</a>).</p>

<p>I used <a href="http://www.antlr.org/grammar/1206736738015/JavaScript.g">Chris Lambrou&rsquo;s JavaScript grammar</a> since this was the most recent.</p>

<p>Open the JavaScript.g file in ANTLRWorks by selecting Open from the File menu.</p>

<p>Edit the JavaScript.g file and add &ldquo;language=CSharp3&rdquo; to the options section.</p>

<pre><code>options 
{ 
    output=AST; 
    backtrack=true; 
    memoize=true; 
    language=CSharp3; 
}
</code></pre>

<p>The language determines what language the parser code will be generated in. To generate C# there are 3 choices for the language.</p>

<ol>
<li><a href="http://www.antlr.org/wiki/display/ANTLR3/Antlr+3+CSharp+Target">CSharp</a>  (.NET 1.1 code generated)</li>
<li>CSharp2 (.NET 2.0 code generated)</li>
<li><a href="http://www.antlr.org/wiki/display/ANTLR3/Antlr3CSharpReleases">CSharp3</a> (.NET 3 code generated)</li>
</ol>


<p>To specify a namespace for the generated C# classes add another line to the JavaScript.g file.</p>

<pre><code>@namespace { ICSharpCode.JavaScriptBinding }
</code></pre>

<p> In ANTLRWorks select Generate Code from the Generate menu. Three files should be generated in an output directory below where  JavaScript.g file is located</p>

<ul>
<li>JavaScript.tokens</li>
<li>JavaScriptLexer.cs</li>
<li>JavaScriptParser.cs</li>
</ul>


<p>The two C# files are the ones we are interested in and we will now take a look at how we can use them in a C# application.</p>

<h2>Using the JavaScript Parser</h2>

<p>The C# files that were generated depend on another set of assemblies.</p>

<p>If you generated code using the CSharp3 target then download the <a href="http://www.tunnelvisionlabs.com/downloads/antlr/antlr-dotnet-tool-3.3.1.7705.7z">CSharp3 assemblies</a>.</p>

<p>For code generated using the CSharp2 and CSharp then download <a href="http://www.antlr.org/download/CSharp">CSharp2 assemblies</a>.</p>

<p>In both cases the assembly you need is Antlr3.Runtime.dll so extract that file from the downloaded zip file.</p>

<p>Now we need to use our parser and lexer.</p>

<p>Create a C# console project and add the JavaScriptLexer.cs and JavaScriptParser.cs files into the project. Add a reference to the Antlr3.Runtime.dll.</p>

<p>Compile the project.</p>

<p>If you receive an error about HIDDEN being undefined then rename HIDDEN to Hidden in the JavaScriptLexer.cs file.</p>

<p>Remove the &ldquo;[System.CLSCompliant(false)]&rdquo; from the lexer and parser files to fix the warning about not requiring CLSCompliant to be set.</p>

<p>In order to get access to the results the parser generates you will need to make a modification to the JavaScriptParser.cs. Make the program() method public, as shown below.</p>

<pre><code>public JavaScriptParser.program_return program()
</code></pre>

<p>If you generate the parser and lexer as java source code files this method is public but for it is private when using any of the CSharp targets.</p>

<p>The correct way to fix the problem with the program method being private is to modify the JavaScript grammar file. If you add the public keyword to JavaScript.g grammar file as shown below then after regenerating the lexer and parser files using ANTLRWorks the  program method will be public.</p>

<pre><code> public program 
      : LT!* sourceElements LT!* EOF! 
      ; 
</code></pre>

<p>Now how do we use the parser? The following code shows you  how.</p>

<pre><code>using System; 
using Antlr.Runtime; 
using Antlr.Runtime.Tree; 
using ICSharpCode.JavaScriptBinding; 

namespace JavaScriptParserConsole 
{ 
    class Program 
    { 
        public static void Main(string[] args) 
        { 
            try { 
                string text = "var a = 1;"; 

                var stream = new ANTLRStringStream(text); 
                var lexer = new JavaScriptLexer(stream); 
                var tokenStream = new CommonTokenStream(lexer); 
                var parser = new JavaScriptParser(tokenStream); 
                JavaScriptParser.program_return programReturn = parser.program(); 

            } catch (Exception ex) { 
                Console.WriteLine(ex.ToString()); 
            } 

            Console.Write("Press any key to continue..."); 
            Console.ReadKey(true); 
        } 
    } 
} 
</code></pre>

<p>First we have some JavaScript code to parse. In this case we have a simple variable assignment. This JavaScript code is then passed to a ANTLRStringStream class. The lexer takes this stream and produces a set of tokens. We turn the lexer into a CommonTokenStream and then this is passed to the parser. The program_return class returned from the parser is an <a href="http://en.wikipedia.org/wiki/Abstract_syntax_tree">Abstract Syntax Tree</a> (AST). Getting access to the AST will depend on how the grammar has been defined. In the JavaScript grammar the top part of the AST is called program.</p>

<pre><code>  public program 
      : LT!* sourceElements LT!* EOF! 
      ;
</code></pre>

<p>This maps to a method called program in our parser class.</p>

<p>Does a grammar always create an AST? It depends on the grammar options. For the JavaScript grammar we are using:</p>

<pre><code>options 
{ 
    output=AST; 
    backtrack=true; 
    memoize=true; 
    language=CSharp3; 
}
</code></pre>

<p>The output is defined to be AST so ANTLR generates classes to produce an AST after parsing the source code. There are two <a href="http://www.antlr.org/wiki/display/ANTLR3/Grammar+options">options</a> for output: AST and template. If this option is not specified the default is AST.</p>

<p>Now we still have not done anything useful with the parse results. So let us display the AST.</p>

<pre><code>using System; 
using Antlr.Runtime; 
using Antlr.Runtime.Tree; 
using ICSharpCode.JavaScriptBinding; 

namespace JavaScriptParserConsole 
{ 
    class Program 
    { 
        public static void Main(string[] args) 
        { 
            try { 
                string text = "var a = 1;"; 

                var stream = new ANTLRStringStream(text); 
                var lexer = new JavaScriptLexer(stream); 
                var tokenStream = new CommonTokenStream(lexer); 
                var parser = new JavaScriptParser(tokenStream); 
                JavaScriptParser.program_return programReturn = parser.program(); 

                var tree = programReturn.Tree as CommonTree; 
                WriteTree(tree); 

            } catch (Exception ex) { 
                Console.WriteLine(ex.ToString()); 
            } 

            Console.Write("Press any key to continue..."); 
            Console.ReadKey(true); 
        } 

        static void WriteTree(CommonTree tree) 
        { 
            WriteLine("Tree.Text: " + tree.Text); 
            WriteLine("Tree.Type: " + tree.Type); 
            WriteLine("Tree.Line: " + tree.Line); 
            WriteLine("Tree.CharPositionInLine: " + tree.CharPositionInLine); 
            WriteLine("Tree.ChildCount: " + tree.ChildCount); 
            WriteLine(""); 

            if (tree.Children != null) { 
                IncreaseIndent(); 
                foreach (CommonTree child in tree.Children) { 
                    WriteTree(child); 
                } 
                DecreaseIndent(); 
            } 
        } 

        static int indent = 0; 

        static void WriteLine(string text) 
        { 
            string indentText = String.Empty.PadRight(indent * 2); 
            Console.WriteLine(indentText + text); 
        } 

        static void IncreaseIndent() 
        { 
            indent++; 
        } 

        static void DecreaseIndent() 
        { 
            indent--; 
        } 
    } 
} 
</code></pre>

<p>We have taken the program_return class that is returned from the parser&rsquo;s program method and displayed its tree.</p>

<pre><code>public class program_return 
    : ParserRuleReturnScope&lt;IToken&gt;, IAstRuleReturnScope&lt;object&gt; 
{ 
    private object _tree; 
    public object Tree { 
        get { return _tree; } 
        set { _tree = value; } 
    } 
}
</code></pre>

<p>The Tree property is a CommonTree but by default ANTLR returns this as an object. We then pass this tree to a method that displays a few properties from the tree and then looks at the tree&rsquo;s children and displays them. Each child is also a tree so we call the WriteTree method recursively. With the simple javascript code of &ldquo;var a = 1;&rdquo; we get the following output when running this code:</p>

<pre><code>Tree.Text: 
Tree.Type: 0 
Tree.Line: 1 
Tree.CharPositionInLine: 0 
Tree.ChildCount: 4 

  Tree.Text: var 
  Tree.Type: 37 
  Tree.Line: 1 
  Tree.CharPositionInLine: 0 
  Tree.ChildCount: 0 

  Tree.Text: a 
  Tree.Type: 5 
  Tree.Line: 1 
  Tree.CharPositionInLine: 4 
  Tree.ChildCount: 0 

  Tree.Text: = 
  Tree.Type: 39 
  Tree.Line: 1 
  Tree.CharPositionInLine: 6 
  Tree.ChildCount: 0 

  Tree.Text: 1 
  Tree.Type: 7 
  Tree.Line: 1 
  Tree.CharPositionInLine: 8 
  Tree.ChildCount: 0 
</code></pre>

<p>Can we specify the type of the Tree? The answer is yes. In the  JavaScript grammar we can specify the type to be used for the Tree property by using the ASTLabelType.</p>

<pre><code>options 
{ 
    output=AST; 
    backtrack=true; 
    memoize=true; 
    ASTLabelType=CommonTree; 
    language=CSharp3; 
} 
</code></pre>

<p>So we can set the tree&rsquo;s type to be CommonTree and we would not need to convert the Tree property from an Object to a CommonTree each time. With this change made the lexer and parser class files need to be regenerated with AntlrWorks. We also have to make the fixes described above (HIDDEN and ClsCompliant) to the generated code.</p>

<p>Now the program_return class has been changed:</p>

<pre><code>public class program_return 
    : ParserRuleReturnScope&lt;IToken&gt;, IAstRuleReturnScope&lt;CommonTree&gt; 
{ 
    private CommonTree _tree; 
    public CommonTree Tree {
        get { return _tree; } 
        set { _tree = value; }
    } 
} 
</code></pre>

<p>Unfortunately this code does not compile and we get the error shown below.</p>

<p>Error CS0738:  &lsquo;ICSharpCode.JavaScriptBinding.JavaScriptParser.program_return&rsquo; does not implement interface member &lsquo;Antlr.Runtime.IAstRuleReturnScope.Tree&rsquo;. ICSharpCode.JavaScriptBinding.JavaScriptParser.program_return.Tree&#8217; cannot implement &lsquo;Antlr.Runtime.IAstRuleReturnScope.Tree&rsquo; because it does not have the matching return type of &lsquo;object&rsquo;.</p>

<p>Looking at the interface definitions it looks like there is a problem with the code generation since the new program_return class does not implement the IAstRuleReturnScope interface completely:</p>

<pre><code>public interface IAstRuleReturnScope&lt;TAstLabel&gt; 
    : IAstRuleReturnScope, IRuleReturnScope 
{ 
    TAstLabel Tree 
    { 
        get; 
    } 
} 

public interface IAstRuleReturnScope : IRuleReturnScope 
{ 
    object Tree 
    { 
        get; 
    } 
}
</code></pre>

<p>So we will have to switch back to not defining the tree&rsquo;s type by not using the ASTLabelType option.</p>

<h2>Summary</h2>

<p>In summary we have taken an existing JavaScript grammar, generated a parser using ANTLR and then used this parser to parse some JavaScript code and display the results held in the AST.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives/">Blog Archives</a>
    
    <a class="next" href="/posts/6">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    
  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - Matt Ward -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> | Themed with <a href="https://github.com/lucaslew/whitespace">Whitespace</a></span>
</p>

</footer>
  










  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
