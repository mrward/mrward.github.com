
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Language Server Protocol support in Visual Studio for Mac 7.4 - Matt Ward</title>
  <meta name="author" content="Matt Ward">

  
  <meta name="description" content="A preview of support for the Language Server Protocol
is now available for Visual Studio for Mac 7.4 as a separate extension. A Language Server can &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://lastexitcode.com/blog/2018/03/18/LanguageServerSupportInVisualStudioMac7-4">
  <link href="/favicon.ico" rel="icon" type="image/x-icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Matt Ward" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='//fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='//fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-34592677-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Matt Ward</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
  
  
  
  
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="lastexitcode.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/projects/">Projects</a></li>
  <li><a href="/blog/archives/">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">Language Server Protocol support in Visual Studio for Mac 7.4</h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2018-03-18T12:30:00+00:00" pubdate data-updated="true">Mar 18<sup>th</sup>, 2018</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>A preview of support for the <a href="https://github.com/Microsoft/language-server-protocol">Language Server Protocol</a>
is now available for Visual Studio for Mac 7.4 as a separate extension.</p>

<p><img src="/images/blog/LanguageServerSupportInVisualStudioMac/DockerLanguageServerClient.gif" title="Docker Language Server client being used in Visual Studio for Mac" alt="Docker Language Server client being used in Visual Studio for Mac"></p>

<p>A Language Server can provide support for programming language features such as:</p>

<ul>
<li>Code completion</li>
<li>Find references</li>
<li>Go to definition</li>
<li>Quick fixes</li>
<li>Method signature help</li>
<li>Errors and warnings diagnostics</li>
<li>Documentation on hover</li>
<li>Document formatting</li>
<li>Rename refactoring</li>
</ul>


<p>The <a href="https://github.com/Microsoft/language-server-protocol">Language Server Protocol</a> provides a way for a
client application, such as Visual Studio for Mac, to communicate with the Language Server in order to
use the programming language features it supports.</p>

<p><a href="https://code.visualstudio.com">Visual Studio Code</a> supports the
<a href="https://code.visualstudio.com/blogs/2016/06/27/common-language-protocol">Language Server Protocol</a>.</p>

<p>A preview of <a href="https://blogs.msdn.microsoft.com/visualstudio/2017/11/21/announcing-language-server-protocol-preview-release/">Language Server Protocol support in Visual Studio 2017 on Windows</a>
has also been announced.</p>

<p>Currently there is no support for debugging. Whilst there is a
<a href="https://code.visualstudio.com/docs/extensionAPI/api-debugging">debugging protocol</a> support
for this is not currently available in Visual Studio for Mac.</p>

<p>The Language Server Protocol does not provide any support for compiling the code. This would need
to be provided by the extension that implements the language client.</p>

<p>More detailed information about the Language Server Protocol can be found on the
<a href="https://microsoft.github.io/language-server-protocol/">Language Server Protocol site</a>.</p>

<p>The <strong>Creating a Language Client</strong> section below will take a more detailed look at how to implement
a custom Language Server Client extension in Visual Studio for Mac.</p>

<h2>Supports</h2>

<ul>
<li>MonoDevelop or Visual Studio Mac 7.4 or later.</li>
</ul>


<h2>Source Code</h2>

<ul>
<li><a href="https://github.com/mrward/monodevelop-language-server-addin">Language Server Client extension for Visual Studio for Mac and MonoDevelop</a></li>
</ul>


<h2>Installation</h2>

<p>The Language Server Client extension is available to download from <a href="https://github.com/mrward/monodevelop-language-server-addin/releases/download/0.1-monodevelop-7.4/MonoDevelop.LanguageServer.Client_0.1.mpack">GitHub</a>.</p>

<p>To install the extension open the Extensions Manager by selecting Extensions&hellip; from the main menu. Click the Install from file button. Select the .mpack file and then click the Open button.</p>

<p>The extension is also available in the Extensions Manager from the
<a href="http://addins.monodevelop.com/Project/Index/307">Visual Studio Extension Repository (Beta channel)</a>.</p>

<h2>Creating a Language Client</h2>

<p>The API provided by the Language Server Client extension follows the <a href="https://docs.microsoft.com/en-us/visualstudio/extensibility/adding-an-lsp-extension">API defined by the
Language Server Protocol extension used by Visual Studio on Windows</a> as
closely as possible.</p>

<p>More detailed documentation on the <a href="https://docs.microsoft.com/en-us/visualstudio/extensibility/language-server-protocol">Language Server Client API</a> provided
by Visual Studio on Windows is available from the <a href="https://docs.microsoft.com/en-us/visualstudio/extensibility/language-server-protocol">Microsoft docs site</a>.</p>

<h3>Prerequisites</h3>

<p>The <a href="https://github.com/mrward/monodevelop-language-server-addin">Language Server Client Extension</a> for
Visual Studio for Mac should be installed.</p>

<p>Also ensure you have the <a href="https://github.com/mhutch/MonoDevelop.AddinMaker">Addin Maker extension installed</a>.
This can be installed by selecting Extensions&hellip; from the main menu top open the Extensions Manager.
Select the Gallery tab and use the text box at the top right to search for the Addin Maker extension.</p>

<p><img src="/images/blog/LanguageServerSupportInVisualStudioMac/ExtensionsDialogAddinMaker.png" title="Addin maker selected in Extensions Manager dialog" alt="Addin maker selected in Extensions Manager dialog"></p>

<p>Click the Install button to install the Addin Maker extension.</p>

<p>The Addin Maker will be used to create the language client extension.</p>

<h3>Creating an IDE Extension project</h3>

<p>The starting point is to create an IDE Extension project. This project template is provided by the
Addin Maker extension and is available
from the New Project dialog, in the Other &ndash; IDE Extensions category.</p>

<p><img src="/images/blog/LanguageServerSupportInVisualStudioMac/NewProjectDialogIdeExtension.png" title="IDE Extension project selected in New Project dialog" alt="IDE Extension project selected in New Project dialog"></p>

<p>After creating the IDE Extensions project, expand the Dependencies folder to show the
Extensions folder. Right click the Extensions folder and select Add Addin Reference.</p>

<p><img src="/images/blog/LanguageServerSupportInVisualStudioMac/NewProjectDialogIdeExtension.png" title="IDE Extension project selected in New Project dialog" alt="IDE Extension project selected in New Project dialog"></p>

<p>Find the MonoDevelop.LanguageServer.Client in the Add Extension Reference dialog. Select it to
toggle its check box and then click the Add button to reference it.</p>

<p><img src="/images/blog/LanguageServerSupportInVisualStudioMac/AddExtensionReferenceDialogLanguageServerClient.png" title="Language Server Client extension in Add Extension Reference dialog" alt="Language Server Client extension in Add Extension Reference dialog"></p>

<p>There are three parts to implementing a language client:</p>

<ul>
<li>Enabling <a href="https://github.com/Microsoft/vs-mef">Managed Extensibility Framework (MEF)</a> support</li>
<li>Defining the supported content
types</li>
<li>Implementing the ILanguageClient interface.</li>
</ul>


<p>First we will take a look at enabling MEF support.</p>

<h3>Enabling Managed Extensibility Framework Support</h3>

<p>Registration of the language client with Visual Studio for Mac is done using the <a href="https://github.com/Microsoft/vs-mef">Managed Extensibility Framework (MEF)</a>
which is supported by Visual Studio for Mac.</p>

<p>In order to use MEF in your language client extension you need to indicate to Visual Studio
for Mac that it should scan your extension for dependencies. This can be done in the
extension&rsquo;s .addin.xml file by adding the filename of your assembly.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;Extension path="/MonoDevelop/Ide/Composition"&gt;
</span><span class='line'>  &lt;Assembly file="MockLanguageExtension.dll" /&gt;
</span><span class='line'>&lt;/Extension&gt;</span></code></pre></td></tr></table></div></figure>


<h3>Content Type Definition</h3>

<p>Your language client needs to indicate what files are supported. This is done by defining
a content type definition.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>using System.ComponentModel.Composition;
</span><span class='line'>using Microsoft.VisualStudio.LanguageServer.Client;
</span><span class='line'>using Microsoft.VisualStudio.Utilities;
</span><span class='line'>
</span><span class='line'>namespace MockLanguageExtension
</span><span class='line'>{
</span><span class='line'>  #pragma warning disable CS0649 // Field is never assigned to.
</span><span class='line'>
</span><span class='line'>  public class FooContentDefinition
</span><span class='line'>  {
</span><span class='line'>      [Export]
</span><span class='line'>      [Name("foo")]
</span><span class='line'>      [BaseDefinition(CodeRemoteContentDefinition.CodeRemoteContentTypeName)]
</span><span class='line'>      internal static ContentTypeDefinition FooContentTypeDefinition;
</span><span class='line'>
</span><span class='line'>      [Export]
</span><span class='line'>      [FileExtension(".foo")]
</span><span class='line'>      [ContentType("foo")]
</span><span class='line'>      internal static FileExtensionToContentTypeDefinition FooFileExtensionDefinition;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  #pragma warning restore CS0649
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>The above content definition indicates that the .foo file extension is supported by the language client.</p>

<p>You can also define a filename, instead of a file extension, as supported by the language client by using
the FileName attribute instead of the FileExtension attribute.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class DockerContentTypeDefinition
</span><span class='line'>{
</span><span class='line'>  [Export]
</span><span class='line'>  [Name("docker")]
</span><span class='line'>  [BaseDefinition(CodeRemoteContentDefinition.CodeRemoteContentTypeName)]
</span><span class='line'>  internal static ContentTypeDefinition contentTypeDefinition;
</span><span class='line'>
</span><span class='line'>  [Export]
</span><span class='line'>  [FileName("Dockerfile")]
</span><span class='line'>  [ContentType("docker")]
</span><span class='line'>  internal static FileExtensionToContentTypeDefinition dockerFileDefinition;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>You will need to add a reference to <strong>System.ComponentModel.Composition</strong> so the <a href="https://msdn.microsoft.com/library/system.componentmodel.composition.exportattribute.aspx">Export attribute</a>
can be used.</p>

<h3>Implementing ILanguageClient</h3>

<p>To integrate the Language Server with Visual Studio for Mac the
<a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.visualstudio.languageserver.client.ilanguageclient">ILanguageClient interface</a>
needs to be implemented.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>using System;
</span><span class='line'>using System.Collections.Generic;
</span><span class='line'>using System.ComponentModel.Composition;
</span><span class='line'>using System.Diagnostics;
</span><span class='line'>using System.IO;
</span><span class='line'>using System.Threading;
</span><span class='line'>using System.Threading.Tasks;
</span><span class='line'>using Microsoft.VisualStudio.LanguageServer.Client;
</span><span class='line'>using Microsoft.VisualStudio.Threading;
</span><span class='line'>using Microsoft.VisualStudio.Utilities;
</span><span class='line'>
</span><span class='line'>namespace MockLanguageExtension
</span><span class='line'>{
</span><span class='line'>  [ContentType("foo")]
</span><span class='line'>  [Export(typeof(ILanguageClient))]
</span><span class='line'>  public class FooLanguageClient : ILanguageClient
</span><span class='line'>  {
</span><span class='line'>      public IEnumerable&lt;string&gt; ConfigurationSections =&gt; null;
</span><span class='line'>
</span><span class='line'>      public object InitializationOptions =&gt; null;
</span><span class='line'>
</span><span class='line'>      public IEnumerable&lt;string&gt; FilesToWatch =&gt; null;
</span><span class='line'>
</span><span class='line'>      public string Name =&gt; "Foo Language Extension";
</span><span class='line'>
</span><span class='line'>      public event AsyncEventHandler&lt;EventArgs&gt; StartAsync;
</span><span class='line'>      public event AsyncEventHandler&lt;EventArgs&gt; StopAsync;
</span><span class='line'>
</span><span class='line'>      public async Task OnLoadedAsync()
</span><span class='line'>      {
</span><span class='line'>          await StartAsync?.InvokeAsync(this, EventArgs.Empty);
</span><span class='line'>      }
</span><span class='line'>
</span><span class='line'>      public Task&lt;Connection&gt; ActivateAsync(CancellationToken token)
</span><span class='line'>      {
</span><span class='line'>          var info = new ProcessStartInfo();
</span><span class='line'>          var programPath = Path.Combine(Path.GetDirectoryName(GetType().Assembly.Location), "server", @"LanguageServer.UI.exe");
</span><span class='line'>          info.FileName = "mono";
</span><span class='line'>          info.Arguments = programPath;
</span><span class='line'>          info.WorkingDirectory = Path.GetDirectoryName(programPath);
</span><span class='line'>          info.UseShellExecute = false;
</span><span class='line'>          info.RedirectStandardInput = true;
</span><span class='line'>          info.RedirectStandardOutput = true;
</span><span class='line'>
</span><span class='line'>          var process = new Process();
</span><span class='line'>          process.StartInfo = info;
</span><span class='line'>
</span><span class='line'>          Connection connection = null;
</span><span class='line'>
</span><span class='line'>          if (process.Start())
</span><span class='line'>          {
</span><span class='line'>              connection = new Connection(process.StandardOutput.BaseStream, process.StandardInput.BaseStream);
</span><span class='line'>          }
</span><span class='line'>
</span><span class='line'>          return Task.FromResult(connection);
</span><span class='line'>      }
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>The class that implements the ILanguageClient interface needs to indicate it supports
the content types that you have defined, and it also needs to indicate that it implements the
ILanguageClient by using the Export attribute.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ContentType("foo")]
</span><span class='line'>[Export(typeof(ILanguageClient))]</span></code></pre></td></tr></table></div></figure>


<p>The language client should return a unique description for the ILanguageClient.Name
property.</p>

<p>The two methods that should be implemented are:</p>

<ul>
<li><a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.visualstudio.languageserver.client.ilanguageclient.onloadedasync">OnLoadedAsync</a></li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.visualstudio.languageserver.client.ilanguageclient.activateasync">ActivateAsync</a>.</li>
</ul>


<p>OnLoadedAsync is called when Visual Studio for Mac has loaded your extension. To activate
your Language Server you need to call StartAsync. The simplest approach is to call StartAsync
in the OnLoadedAsync method.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> public async Task OnLoadedAsync()
</span><span class='line'>  {
</span><span class='line'>      await StartAsync?.InvokeAsync(this, EventArgs.Empty);
</span><span class='line'>  }</span></code></pre></td></tr></table></div></figure>


<p>Calling StartAsync will cause Visual Studio for Mac to call the ILanguageClient&rsquo;s
ActivateAsync method. This is where you can start the Language Server.</p>

<p>The ActivateAsync method should return a Connection object with the streams that
will be used to communicate with the Language Server. Standard input and output streams
are supported as well as sockets.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var connection = new Connection(process.StandardOutput.BaseStream, process.StandardInput.BaseStream);</span></code></pre></td></tr></table></div></figure>


<p>The first time you try to run and debug your language client extension you will see an error
in the Application Output similar to:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>WARNING: The add-in 'MockLanguageExtension,1.0' could not be updated because some of its 
</span><span class='line'>dependencies are missing or not compatible:
</span><span class='line'>  missing: MonoDevelop.LanguageServer.Client,0.1</span></code></pre></td></tr></table></div></figure>


<p>The Addin Maker runs your language client extension using its own extension database. The
MonoDevelop.LanguageServer.Client extension needs to be installed into this separate database
in order to be able to run and debug your language client extension.</p>

<p>To do this run your language client extension project in Visual Studio for Mac and
install the Language Server Client extension using the Extensions Manager in the instance
of Visual Studio for Mac that is started. Then stop debugging and re-run your extension project
again, and your language client should now be used when you open a supported file.</p>

<p>The content type registration and the ILanguageClient implementation is the minimum
that is needed in order to integrate your Language Server with Visual Studio for Mac.
Now let us take a look at other optional things that can be implemented.</p>

<h3>Receiving Custom Messages</h3>

<p>Your Language Server may support messages that are not part of the standard
Language Server Protocol.</p>

<p>In order to support receiving custom messages the class that implements ILanguageClient should also
implement the
<a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.visualstudio.languageserver.client.ilanguageclientcustommessage">ILanguageClientCustomMessage</a>
interface. The CustomMessageTarget property should return an object that will receive the messages.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public object CustomMessageTarget =&gt; new CustomMessageTarget ();
</span><span class='line'>public object MiddleLayer =&gt; null;
</span><span class='line'>
</span><span class='line'>public Task AttachForCustomMessageAsync(JsonRpc rpc)
</span><span class='line'>{
</span><span class='line'>  return Task.CompletedTask;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>An example CustomMessageTarget class is shown below.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>using Newtonsoft.Json.Linq;
</span><span class='line'>using StreamJsonRpc;
</span><span class='line'>
</span><span class='line'>namespace MockLanguageExtension
</span><span class='line'>{
</span><span class='line'>  public class CustomMessageTarget
</span><span class='line'>  {
</span><span class='line'>      [JsonRpcMethod("test/customNotification")]
</span><span class='line'>      public void OnCustomNotification(JToken arg)
</span><span class='line'>      {
</span><span class='line'>          // Handle custom message from the Language Server.
</span><span class='line'>      }
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>Sending Custom Messages</h3>

<p>To send custom messages to the Language Server the class that implements the
ILanguageClient interface should also implement the
<a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.visualstudio.languageserver.client.ilanguageclientcustommessage">ILanguageClientCustomMessage</a> interface.</p>

<p>The AttachForCustomMessageAsync method
should save the JsonRpc object passed and then you can use the JsonRpc object to
send custom messages to the Language Server.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> JsonRpc rpc;
</span><span class='line'>
</span><span class='line'>  public Task AttachForCustomMessageAsync(JsonRpc rpc)
</span><span class='line'>  {
</span><span class='line'>      this.rpc = rpc;
</span><span class='line'>      return Task.CompletedTask;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  public async Task SendMessageToServer()
</span><span class='line'>  {
</span><span class='line'>      string text = await rpc.InvokeWithParameterObjectAsync&lt;string&gt;("GetText");
</span><span class='line'>      MessageService.ShowMessage("Text from language server:", text);
</span><span class='line'>  }</span></code></pre></td></tr></table></div></figure>


<h3>Middle Layer</h3>

<p>The ILanguageClientCustomMessage defines a MiddleLayer property. An object returned
from the MiddleLayer property can be used to intercept messages sent to and received
from the Language Server. The MiddleLayer object can implement the following
interfaces:</p>

<ul>
<li><a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.visualstudio.languageserver.client.ilanguageclientcompletionprovider">ILanguageClientCompletionProvider</a></li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.visualstudio.languageserver.client.ilanguageclientexecutecommandprovider">ILanguageClientExecuteCommandProvider</a></li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.visualstudio.languageserver.client.ilanguageclientworkspacesymbolprovider">ILanguageClientWorkspaceSymbolProvider</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>using System;
</span><span class='line'>using System.Threading.Tasks;
</span><span class='line'>using Microsoft.VisualStudio.LanguageServer.Client;
</span><span class='line'>using Microsoft.VisualStudio.LanguageServer.Protocol;
</span><span class='line'>
</span><span class='line'>namespace MockLanguageExtension
</span><span class='line'>{
</span><span class='line'>  class MiddleLayerProvider : ILanguageClientCompletionProvider
</span><span class='line'>  {
</span><span class='line'>      public Task&lt;object&gt; RequestCompletions(
</span><span class='line'>          TextDocumentPositionParams param,
</span><span class='line'>          Func&lt;TextDocumentPositionParams, Task&lt;object&gt;&gt; sendRequest)
</span><span class='line'>      {
</span><span class='line'>          return sendRequest(param);
</span><span class='line'>      }
</span><span class='line'>
</span><span class='line'>      public async Task&lt;CompletionItem&gt; ResolveCompletion(
</span><span class='line'>          CompletionItem item,
</span><span class='line'>          Func&lt;CompletionItem, Task&lt;CompletionItem&gt;&gt; sendRequest)
</span><span class='line'>      {
</span><span class='line'>          return await sendRequest(item);
</span><span class='line'>      }
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Note that currently not all the Language Server messages can be intercepted.</p>

<p>The full source code to the sample Language Server Client Extension created
whilst writing this blog post is available on
<a href="https://github.com/mrward/sample-language-server-client-extension">GitHub</a></p>

<p>There are other examples included with the
<a href="https://github.com/mrward/monodevelop-language-server-addin">Language Server Client extension source code</a>
on GitHub, however these are not standalone and are compiled with the
Language Server Client extension.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Authored by <span class="fn">Matt Ward</span></span>

      








  


<time datetime="2018-03-18T12:30:00+00:00" pubdate data-updated="true">Mar 18<sup>th</sup>, 2018</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/languageserverprotocol/'>languageserverprotocol</a>, <a class='category' href='/blog/categories/monodevelop/'>monodevelop</a>, <a class='category' href='/blog/categories/vsmac/'>vsmac</a>, <a class='category' href='/blog/categories/xamarin/'>xamarin</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://lastexitcode.com/blog/2018/03/18/LanguageServerSupportInVisualStudioMac7-4/" data-via="" data-counturl="http://lastexitcode.com/blog/2018/03/18/LanguageServerSupportInVisualStudioMac7-4/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2018/03/11/NetCoreSupportInVisualStudioMac7-4/" title="Previous Post: .NET Core Support in Visual Studio for Mac 7.4">&laquo; .NET Core Support in Visual Studio for Mac 7.4</a>
      
      
        <a class="basic-alignment right" href="/blog/2018/05/19/NuGetSupportInVisualStudioMac7-5/" title="Next Post: NuGet Support in Visual Studio for Mac 7.5">NuGet Support in Visual Studio for Mac 7.5 &raquo;</a>
      
    </p>
  </footer>
</article>


</div>

<aside class="sidebar">
  
    
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2022 - Matt Ward -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> | Themed with <a href="https://github.com/lucaslew/whitespace">Whitespace</a></span>
</p>

</footer>
  










  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
